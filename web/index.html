<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Match Recording - App web per registrare e analizzare partite">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Match Recording">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">
  
  <!-- Prevenire sleep su iOS durante registrazione -->
  <meta name="format-detection" content="telephone=no">

  <!-- Chrome specific tags -->
  <meta name="theme-color" content="#0175C2">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>Match Recording - Web App</title>
  <link rel="manifest" href="manifest.json">
  
  <!-- Wake Lock API polyfill per iOS -->
  <script>
    // Prevenire sleep dello schermo durante registrazione
    if ('wakeLock' in navigator) {
      console.log('üîì Wake Lock API disponibile');
    } else {
      console.log('‚ö†Ô∏è Wake Lock API non supportata su questo browser');
    }
  </script>

  <!-- Minimal in-page crash logger for devices without Web Inspector -->
  <script>
    (function () {
      var LOG_KEY = 'mr_error_log';
      var PERF_KEY = 'mr_perf_log';
      var MAX_LINES = 200;

      function loadLogs() {
        try {
          return JSON.parse(localStorage.getItem(LOG_KEY) || '[]');
        } catch (e) {
          return [];
        }
      }

      function loadPerfLogs() {
        try {
          return JSON.parse(localStorage.getItem(PERF_KEY) || '[]');
        } catch (e) {
          return [];
        }
      }

      function loadAllLogs() {
        var errorLogs = loadLogs().map(function (line) {
          return '[error] ' + line;
        });
        var perfLogs = loadPerfLogs().map(function (line) {
          return '[perf]  ' + line;
        });
        return errorLogs.concat(perfLogs);
      }

      function saveLogs(lines) {
        try {
          localStorage.setItem(LOG_KEY, JSON.stringify(lines.slice(-MAX_LINES)));
        } catch (e) {
          // Ignore storage errors.
        }
      }

      function formatError(message, source, line, column, error) {
        var parts = [];
        parts.push(new Date().toISOString());
        parts.push(String(message || 'Unknown error'));
        if (source) {
          parts.push('at ' + source + ':' + line + ':' + column);
        }
        if (error && error.stack) {
          parts.push(String(error.stack));
        }
        return parts.join('\n');
      }

      function addLog(entry) {
        var logs = loadLogs();
        logs.push(entry);
        saveLogs(logs);
        renderPanel(loadAllLogs());
      }

      function createUi() {
        if (document.getElementById('mr-log-button')) {
          return;
        }

        var button = document.createElement('button');
        button.id = 'mr-log-button';
        button.textContent = 'Logs';
        button.style.cssText = [
          'position:fixed',
          'right:8px',
          'top:8px',
          'z-index:99999',
          'background:#111',
          'color:#fff',
          'border:1px solid #444',
          'border-radius:6px',
          'padding:6px 10px',
          'font:12px/1.2 sans-serif',
          'opacity:0.8'
        ].join(';');

        var panel = document.createElement('div');
        panel.id = 'mr-log-panel';
        panel.style.cssText = [
          'position:fixed',
          'right:8px',
          'top:40px',
          'z-index:99999',
          'width:90vw',
          'max-width:420px',
          'max-height:60vh',
          'overflow:auto',
          'background:rgba(0,0,0,0.85)',
          'color:#f5f5f5',
          'border:1px solid #444',
          'border-radius:8px',
          'padding:8px',
          'font:11px/1.3 monospace',
          'display:none'
        ].join(';');

        var actions = document.createElement('div');
        actions.style.cssText = 'display:flex;gap:6px;margin-bottom:6px;';

        var clearBtn = document.createElement('button');
        clearBtn.textContent = 'Clear';
        clearBtn.style.cssText = 'font:11px/1.2 sans-serif;padding:4px 6px;';
        clearBtn.onclick = function () {
          saveLogs([]);
          try {
            localStorage.setItem(PERF_KEY, JSON.stringify([]));
          } catch (e) {
            // Ignore storage errors.
          }
          renderPanel([]);
        };

        var copyBtn = document.createElement('button');
        copyBtn.textContent = 'Copy';
        copyBtn.style.cssText = 'font:11px/1.2 sans-serif;padding:4px 6px;';
        copyBtn.onclick = function () {
          var logs = loadAllLogs().join('\n\n---\n\n');
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(logs);
          } else {
            var textarea = document.createElement('textarea');
            textarea.value = logs;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
          }
        };

        actions.appendChild(clearBtn);
        actions.appendChild(copyBtn);
        panel.appendChild(actions);

        var content = document.createElement('pre');
        content.id = 'mr-log-content';
        content.style.cssText = 'white-space:pre-wrap;margin:0;';
        panel.appendChild(content);

        button.onclick = function () {
          panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
          renderPanel(loadAllLogs());
        };

        document.body.appendChild(button);
        document.body.appendChild(panel);
      }

      function renderPanel(lines) {
        var content = document.getElementById('mr-log-content');
        if (!content) {
          return;
        }
        content.textContent = lines.join('\n\n---\n\n');
      }

      window.addEventListener('error', function (event) {
        addLog(formatError(event.message, event.filename, event.lineno, event.colno, event.error));
      });

      window.addEventListener('unhandledrejection', function (event) {
        var reason = event.reason;
        var message = (reason && reason.message) ? reason.message : String(reason || 'Unhandled rejection');
        var stack = (reason && reason.stack) ? reason.stack : '';
        addLog([new Date().toISOString(), message, stack].filter(Boolean).join('\n'));
      });

      var originalError = console.error;
      console.error = function () {
        try {
          var args = Array.prototype.slice.call(arguments);
          addLog([new Date().toISOString(), args.map(String).join(' ')].join('\n'));
        } catch (e) {
          // Ignore logging failures.
        }
        if (originalError) {
          originalError.apply(console, arguments);
        }
      };

      document.addEventListener('DOMContentLoaded', createUi);
    })();
  </script>
</head>
<body>
  <script src="flutter_bootstrap.js" async></script>
</body>
</html>
